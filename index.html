<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web MIDI Bass Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #111;
            color: #e5e5e5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        
        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #3b82f6; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #4b5563; border-radius: 2px;
        }

        /* Guitar Specific Range Color */
        .guitar-range::-webkit-slider-thumb {
            background: #eab308; /* Yellow-500 */
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.5);
        }

        /* Piano Keys */
        .key { transition: all 0.1s ease; cursor: pointer; }
        .white-key.active { background-color: #3b82f6 !important; transform: translateY(2px); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .black-key.active { background-color: #3b82f6 !important; transform: translateY(2px); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        
        /* Mapped Indicator */
        .key.mapped::after {
            content: ''; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
            width: 6px; height: 6px; background-color: #eab308; border-radius: 50%;
        }

        .led { width: 8px; height: 8px; border-radius: 50%; background-color: #333; transition: background-color 0.1s; display: inline-block; }
        .led.on { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .led.signal { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
        .led.tx { background-color: #eab308; box-shadow: 0 0 5px #eab308; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #eab308; }
        .toggle-checkbox:checked + .toggle-label { background-color: #eab308; }

        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
            padding-right: 2.5rem; -webkit-appearance: none; appearance: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-b from-gray-900 to-black">

    <!-- Overlay -->
    <div id="start-overlay" class="fixed inset-0 bg-black/95 z-50 flex items-center justify-center flex-col text-center p-4">
        <h1 class="text-4xl font-bold mb-2 text-blue-500">MIDI Bass Mapper</h1>
        <p class="mb-8 text-gray-400 max-w-md text-sm">
            Verbinde deine Bassleiste und konfiguriere jede Taste einzeln.<br>
            Ideal für Steirische Harmonika Setups.
        </p>
        <button id="start-btn" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-full transition transform hover:scale-105 shadow-lg shadow-blue-500/30">
            System Starten
        </button>
        <div id="ios-warning" class="hidden mt-4 bg-red-900/50 border border-red-500 p-4 rounded text-left max-w-xs">
            <h3 class="text-red-400 font-bold text-sm mb-2">⚠️ iPhone/iPad erkannt</h3>
            <p class="text-xs text-gray-300">Nutze bitte die App "Web MIDI Browser".</p>
        </div>
    </div>

    <div class="w-full max-w-6xl bg-gray-900/80 backdrop-blur rounded-xl border border-gray-800 shadow-2xl overflow-hidden p-4 md:p-6">
        
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-gray-800 pb-4 gap-4">
            <!-- INPUT Status -->
            <div class="flex items-center gap-4 bg-black/40 px-4 py-2 rounded-full border border-gray-800">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500 uppercase font-bold">Input</span>
                    <div id="led-rx" class="led"></div>
                </div>
                <div class="h-4 w-px bg-gray-700"></div>
                <select id="midi-in-select" class="bg-transparent text-xs text-blue-400 font-bold outline-none w-32">
                    <option value="">Kein Gerät...</option>
                </select>
            </div>

            <!-- OUTPUT Status -->
            <div class="flex items-center gap-4 bg-black/40 px-4 py-2 rounded-full border border-gray-800">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500 uppercase font-bold">Output (App)</span>
                    <div id="led-tx" class="led"></div>
                </div>
                <div class="h-4 w-px bg-gray-700"></div>
                <select id="midi-out-select" class="bg-transparent text-xs text-yellow-500 font-bold outline-none w-32">
                    <option value="">Kein Output...</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- LEFT: VISUALIZER & SYNTH -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Visual Keyboard -->
                <div class="bg-black rounded-xl border-4 border-gray-800 shadow-inner relative overflow-hidden p-4">
                    <div class="absolute top-2 left-3 text-[10px] text-gray-600 font-mono tracking-widest pointer-events-none">EINGANGS-MONITOR</div>
                    <!-- FIXED: items-start aligns black keys to top (back of piano) -->
                    <div class="relative h-40 select-none flex justify-center items-start pt-6 gap-0.5" id="keyboard-container">
                        <!-- Keys Generated by JS -->
                    </div>
                </div>

                <!-- Synth Controls (Compact) -->
                <div class="bg-gray-800/30 p-4 rounded-lg border border-gray-700/50 flex flex-wrap gap-4 items-center justify-between">
                    <div>
                        <label class="text-[10px] text-gray-500 block uppercase tracking-wider mb-1">Sound</label>
                        <select id="preset-select" class="bg-gray-900 text-xs text-gray-200 border border-gray-600 rounded px-2 py-1">
                            <option value="ebass">E-Bass (Real)</option>
                            <option value="helikon">Helikon</option>
                            <option value="synth">Synth</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-400">Lokal Sound</span>
                        <div class="relative inline-block w-8 align-middle select-none">
                            <input type="checkbox" id="local-sound-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer" style="top:0; left:0; transition: all 0.3s;" checked/>
                            <label for="local-sound-toggle" class="block overflow-hidden h-4 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                    <!-- MIDI Channels -->
                    <div class="flex gap-2 text-xs text-gray-500">
                        <span>Bass Ch: <input type="number" id="ch-bass" value="3" class="w-8 bg-gray-900 text-center rounded border border-gray-700"></span>
                        <span>Guit Ch: <input type="number" id="ch-guit" value="2" class="w-8 bg-gray-900 text-center rounded border border-gray-700"></span>
                    </div>
                </div>
            </div>

            <!-- RIGHT: MAPPING EDITOR -->
            <div class="lg:col-span-1 bg-gray-800 rounded-xl border border-gray-700 p-0 overflow-hidden flex flex-col h-full">
                <div class="bg-gradient-to-r from-gray-900 to-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Mapping Editor
                    </h2>
                    <span id="editor-status" class="text-[10px] text-gray-500 uppercase bg-gray-900 px-2 py-1 rounded">Bereit</span>
                </div>

                <div class="p-6 flex-1 flex flex-col gap-6" id="editor-content">
                    
                    <!-- Selected Key Display -->
                    <div class="text-center pb-4 border-b border-gray-700">
                        <div class="text-xs text-gray-500 uppercase tracking-widest mb-1">Gewählte Taste (Input)</div>
                        <div class="text-4xl font-black text-white" id="selected-note-display">-</div>
                        <div class="text-xs text-gray-600 font-mono mt-1" id="selected-note-midi">MIDI: -</div>
                    </div>

                    <!-- Config Form -->
                    <div class="space-y-4 opacity-50 pointer-events-none transition-opacity" id="mapping-controls">
                        
                        <!-- Bass Output -->
                        <div>
                            <label class="flex justify-between text-xs text-blue-400 font-bold mb-1">
                                <span>1. SPIELE BASS TON</span>
                            </label>
                            <select id="map-bass-note" class="w-full bg-gray-900 text-sm text-white border border-gray-600 rounded px-3 py-2 outline-none focus:border-blue-500">
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <!-- Chord Output -->
                        <div>
                            <label class="flex justify-between text-xs text-yellow-500 font-bold mb-1">
                                <span>2. SENDE AKKORD (Gitarre)</span>
                            </label>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="col-span-2">
                                    <select id="map-chord-root" class="w-full bg-gray-900 text-sm text-white border border-gray-600 rounded px-3 py-2 outline-none focus:border-yellow-500">
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                                <div>
                                    <select id="map-chord-type" class="w-full bg-gray-900 text-sm text-white border border-gray-600 rounded px-3 py-2 outline-none focus:border-yellow-500">
                                        <option value="maj">Dur</option>
                                        <option value="min">Moll</option>
                                        <option value="7">7</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-[10px] text-gray-500 mt-1 italic" id="chord-info-text">
                                Sendet Grundton und Terz/Quinte auf Kanal 2
                            </div>
                        </div>

                        <!-- Reset -->
                        <div class="pt-2 text-center">
                            <button id="btn-reset-map" class="text-xs text-red-400 hover:text-red-300 underline">Standard wiederherstellen</button>
                        </div>
                    </div>

                    <div class="mt-auto bg-blue-900/20 p-3 rounded border border-blue-800/30 text-xs text-blue-200">
                        ℹ️ Drücke eine Taste auf deiner Leiste, um sie zu konfigurieren. C-Dur ist meistens C3 [48] oder C2 [36].
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBALS ---
        let audioCtx;
        let masterGain;
        let midiAccess = null;
        let activeOutput = null;
        let activeVoices = {}; // Local Audio
        let activeNoteState = {}; 

        // USER CONFIG & MAPPINGS
        // Mappings: { midiNote: { bass: int, chordRoot: int, chordType: 'maj'/'min' } }
        let customMappings = {};
        let selectedNote = null; // Currently being edited

        let config = {
            localSound: true,
            bassCh: 3,
            guitCh: 2,
            strumSpeed: 0.03,
            // Synth
            model: 'string', 
            cutoff: 2000, 
            attack: 0.01, 
            release: 0.3 
        };

        const notesList = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        // --- INIT ---
        function initAudio() {
            if (audioCtx) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.4;
            
            const comp = audioCtx.createDynamicsCompressor();
            masterGain.connect(comp);
            comp.connect(audioCtx.destination);
            
            document.getElementById('start-overlay').classList.add('hidden');
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess({ sysex: false }).then(onMIDISuccess, onMIDIFailure);
            } else if(isIOS) {
                document.getElementById('ios-warning').classList.remove('hidden');
            }
            
            initMappingUI();
        }

        // --- SYNTH ENGINE (Optimized E-Bass) ---
        class Voice {
            constructor(note, velocity) {
                if(!config.localSound) return;
                this.ctx = audioCtx;
                this.gain = this.ctx.createGain();
                this.filter = this.ctx.createBiquadFilter();
                const now = this.ctx.currentTime;
                const freq = 440 * Math.pow(2, (note - 69) / 12);
                this.oscs = [];

                // E-Bass Model (String + Body)
                const osc1 = this.ctx.createOscillator();
                osc1.type = 'triangle'; // Body
                osc1.frequency.value = freq;
                
                const osc2 = this.ctx.createOscillator();
                osc2.type = 'sawtooth'; // String buzz
                osc2.frequency.value = freq;
                
                const osc2Gain = this.ctx.createGain();
                osc2Gain.gain.setValueAtTime(0.5, now);
                osc2Gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);

                this.filter.type = 'lowpass';
                this.filter.frequency.setValueAtTime(config.cutoff, now);
                this.filter.frequency.exponentialRampToValueAtTime(300, now + 0.2); 
                this.filter.Q.value = 1.0;

                // Click
                const buf = this.ctx.createBuffer(1, this.ctx.sampleRate * 0.01, this.ctx.sampleRate);
                const d = buf.getChannelData(0);
                for(let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
                const click = this.ctx.createBufferSource();
                click.buffer = buf;
                const clickG = this.ctx.createGain();
                clickG.gain.value = 0.2;

                osc1.connect(this.filter);
                osc2.connect(osc2Gain);
                osc2Gain.connect(this.filter);
                click.connect(clickG);
                clickG.connect(this.gain);
                this.filter.connect(this.gain);
                this.gain.connect(masterGain);

                osc1.start(now);
                osc2.start(now);
                click.start(now);
                this.oscs.push(osc1, osc2, click);

                this.gain.gain.setValueAtTime(0, now);
                this.gain.gain.linearRampToValueAtTime(velocity/127, now + 0.01);
            }

            stop() {
                if(!this.gain) return;
                const now = this.ctx.currentTime;
                this.gain.gain.cancelScheduledValues(now);
                this.gain.gain.setValueAtTime(this.gain.gain.value, now);
                this.gain.gain.exponentialRampToValueAtTime(0.001, now + config.release);
                const stopT = now + config.release + 0.1;
                this.oscs.forEach(o => { try{o.stop(stopT)}catch(e){} });
                setTimeout(() => this.gain.disconnect(), (config.release*1000)+200);
            }
        }

        // --- MAPPING LOGIC ---

        function getNoteName(val) {
            const oct = Math.floor(val / 12) - 1;
            return notesList[val % 12] + oct;
        }

        function selectNoteForEditing(note) {
            selectedNote = note;
            
            // Visuals
            document.querySelectorAll('.key').forEach(k => k.classList.remove('border-blue-500', 'border-2'));
            const k = document.querySelector(`.key[data-note="${note}"]`);
            if(k) k.classList.add('border-blue-500', 'border-2');

            // UI Update
            document.getElementById('selected-note-display').innerText = getNoteName(note);
            document.getElementById('selected-note-midi').innerText = `MIDI Note: ${note}`;
            document.getElementById('editor-status').innerText = "Bearbeitung...";
            document.getElementById('editor-status').classList.add('text-blue-400');
            document.getElementById('mapping-controls').classList.remove('opacity-50', 'pointer-events-none');

            // Load Existing Mapping or Default
            const map = customMappings[note];
            if(map) {
                document.getElementById('map-bass-note').value = map.bass;
                document.getElementById('map-chord-root').value = map.chordRoot;
                document.getElementById('map-chord-type').value = map.chordType;
            } else {
                // Default: Bass = Input, Chord = Input Major
                document.getElementById('map-bass-note').value = note;
                document.getElementById('map-chord-root').value = note; 
                document.getElementById('map-chord-type').value = 'maj';
            }
        }

        function saveCurrentMapping() {
            if(selectedNote === null) return;
            const bass = parseInt(document.getElementById('map-bass-note').value);
            const root = parseInt(document.getElementById('map-chord-root').value);
            const type = document.getElementById('map-chord-type').value;

            customMappings[selectedNote] = {
                bass: bass,
                chordRoot: root,
                chordType: type
            };
            
            // Visual feedback on key
            const k = document.querySelector(`.key[data-note="${selectedNote}"]`);
            if(k) k.classList.add('mapped');
            
            // Update info text
            const rootName = getNoteName(root);
            document.getElementById('chord-info-text').innerText = `Spielt ${rootName}-${type.toUpperCase()} Akkord (MIDI Root: ${root})`;
        }

        // --- NOTE LOGIC ---

        function noteOn(note, velocity) {
            // 1. Select for UI Editing
            selectNoteForEditing(note);

            // 2. Determine Output based on Mapping
            let bassOut = note;
            let chordRoot = note; 
            let chordType = 'maj';

            if(customMappings[note]) {
                bassOut = customMappings[note].bass;
                chordRoot = customMappings[note].chordRoot;
                chordType = customMappings[note].chordType;
            } else {
                // Auto Logic if no mapping
                chordRoot = note + 12;
            }

            // Save state for NoteOff
            activeNoteState[note] = { bass: bassOut, root: chordRoot, type: chordType };

            // 3. Play/Send Bass
            if(activeVoices[note]) activeVoices[note].stop();
            activeVoices[note] = new Voice(bassOut, velocity); 
            sendMidiNote(config.bassCh, bassOut, velocity);

            // 4. Send Chord
            playChord(chordRoot, chordType, velocity, note);

            // Visuals
            highlightKey(note, true);
            uiSignal('rx');
        }

        function noteOff(note) {
            const state = activeNoteState[note];
            if(!state) return; 

            // Stop Local
            if(activeVoices[note]) { activeVoices[note].stop(); delete activeVoices[note]; }
            
            // Stop MIDI Bass
            sendMidiNote(config.bassCh, state.bass, 0);
            
            // Stop Chord
            stopChord(state.root, state.type, note);

            delete activeNoteState[note];
            highlightKey(note, false);
        }

        // --- CHORD GENERATION ---
        let activeChords = {}; // note -> [midi notes]

        function playChord(root, type, velocity, triggerNote) {
            let intervals = [0, 4, 7]; // Maj
            if(type === 'min') intervals = [0, 3, 7];
            if(type === '7') intervals = [0, 4, 7, 10];

            const notes = intervals.map(i => root + i);
            activeChords[triggerNote] = notes;

            // Strum
            notes.forEach((n, i) => {
                setTimeout(() => {
                    if(activeChords[triggerNote]) {
                        sendMidiNote(config.guitCh, n, Math.floor(velocity*0.8));
                    }
                }, i * (config.strumSpeed * 1000));
            });
        }

        function stopChord(root, type, triggerNote) {
            const notes = activeChords[triggerNote];
            if(notes) {
                notes.forEach(n => sendMidiNote(config.guitCh, n, 0));
                delete activeChords[triggerNote];
            }
        }

        // --- MIDI I/O ---
        function onMIDISuccess(access) {
            midiAccess = access;
            updateDeviceLists();
            midiAccess.onstatechange = updateDeviceLists;
        }
        function onMIDIFailure() {}

        function updateDeviceLists() {
            const inSelect = document.getElementById('midi-in-select');
            inSelect.innerHTML = '<option value="">Kein Gerät...</option>';
            midiAccess.inputs.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.id; opt.text = i.name;
                inSelect.appendChild(opt);
                i.onmidimessage = handleMIDIMessage; // Auto bind
            });

            const outSelect = document.getElementById('midi-out-select');
            outSelect.innerHTML = '<option value="">Kein Output...</option>';
            midiAccess.outputs.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.id; opt.text = o.name;
                outSelect.appendChild(opt);
            });
        }

        document.getElementById('midi-out-select').addEventListener('change', (e) => {
            activeOutput = e.target.value ? midiAccess.outputs.get(e.target.value) : null;
        });

        function handleMIDIMessage(msg) {
            const cmd = msg.data[0] >> 4;
            const note = msg.data[1];
            const vel = (msg.data.length > 2) ? msg.data[2] : 0;
            if(cmd === 9 && vel > 0) noteOn(note, vel);
            else if(cmd === 8 || (cmd === 9 && vel === 0)) noteOff(note);
        }

        function sendMidiNote(ch, note, vel) {
            if(!activeOutput) return;
            const stat = (vel > 0 ? 0x90 : 0x80) + (ch-1);
            try { 
                activeOutput.send([stat, note, vel]); 
                if(vel > 0) uiSignal('tx');
            } catch(e){}
        }

        // --- UI ---
        function initMappingUI() {
            // Populate Selects with Notes
            const bassSel = document.getElementById('map-bass-note');
            const chordSel = document.getElementById('map-chord-root');
            
            // Generate options from C1 (24) to C5 (72)
            for(let i=24; i<=72; i++) {
                const name = getNoteName(i);
                // Display text includes MIDI number for reference
                const displayText = `${name} [${i}]`;
                const opt1 = new Option(displayText, i);
                const opt2 = new Option(displayText, i);
                bassSel.add(opt1);
                chordSel.add(opt2);
            }

            // Bind Change Events
            ['map-bass-note', 'map-chord-root', 'map-chord-type'].forEach(id => {
                document.getElementById(id).addEventListener('change', saveCurrentMapping);
            });

            document.getElementById('btn-reset-map').addEventListener('click', () => {
                if(selectedNote) {
                    delete customMappings[selectedNote];
                    selectNoteForEditing(selectedNote); // Refresh UI
                    document.querySelector(`.key[data-note="${selectedNote}"]`).classList.remove('mapped');
                }
            });

            // Channels
            document.getElementById('ch-bass').addEventListener('change', e => config.bassCh = parseInt(e.target.value));
            document.getElementById('ch-guit').addEventListener('change', e => config.guitCh = parseInt(e.target.value));
            document.getElementById('local-sound-toggle').addEventListener('change', e => config.localSound = e.target.checked);
            
            buildKeyboard();
        }

        function buildKeyboard() {
            const container = document.getElementById('keyboard-container');
            // Range C2 (36) to C4 (60) for display
            for(let i=36; i<=64; i++) {
                const isBlack = [1,3,6,8,10].includes(i%12);
                // Corrected alignment: Black keys hang from top (items-start on container)
                const k = document.createElement('div');
                k.className = `key relative rounded-b border-gray-900 border ${isBlack ? 'black-key bg-black w-6 h-24 -mx-3 z-10' : 'white-key bg-white w-8 h-40 z-0'}`;
                k.dataset.note = i;
                k.onclick = () => noteOn(i, 100); 
                k.onmouseup = () => noteOff(i);
                k.onmouseleave = () => noteOff(i);
                container.appendChild(k);
            }
        }

        function highlightKey(note, active) {
            const k = document.querySelector(`.key[data-note="${note}"]`);
            if(k) active ? k.classList.add('active') : k.classList.remove('active');
        }

        function uiSignal(type) {
            const el = document.getElementById(`led-${type}`);
            el.classList.add('on');
            setTimeout(() => el.classList.remove('on'), 50);
        }

        // Start
        document.getElementById('start-btn').addEventListener('click', initAudio);

    </script>
</body>
</html>
